---
title: "Other SimPy Examples"
author: "IÃ±aki Ucar"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: yes
vignette: >
  %\VignetteIndexEntry{Other SimPy Examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, cache = FALSE, include=FALSE}
knitr::opts_chunk$set(collapse = T, comment = "#>",
                      fig.width = 6, fig.height = 4, fig.align = "center")
library(simmer)
detach("package:simmer")
library(ggplot2)
theme_set(theme_bw())
```

## Introduction

These examples are adapted from the Python package 'SimPy', [here](https://simpy.readthedocs.io/en/latest/examples). Users familiar with SimPy may find these examples helpful for transitioning to simmer. Some very basic material is not covered. Beginners should first read the vignettes 'Introduction', 'Terminology', 'Advanced Trajectory Usage' and 'The Bank Tutorial'.

## Movie Renege

From [here](https://simpy.readthedocs.io/en/latest/examples/movie_renege.html):

> This example models a movie theater with one ticket counter selling tickets for three movies (next show only). People arrive at random times and try to buy a random number (1-6) of tickets for a random movie. When a movie is sold out, all people waiting to buy a ticket for that movie renege (leave the queue).

First of all, we load the libraries and prepare the environment. We will use `dplyr` later for the data analysis. There is a reason for loading it before `simmer`, and it is to mask `dplyr::select` with `simmer::select` and not the other way round.

```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(simmer)

TICKETS <- 50     # Number of tickets per movie
SIM_TIME <- 120   # Simulate until
movies <- c("R Unchained", "Kill Process", "Pulp Implementation")

# setup
set.seed(42)
env <- simmer()
```

The main actor of this simulation is the _moviegoer_, a process that will try to buy a number of tickets for a certain movie. The logic is as follows:

1. __Select__ a movie and go to the theater.
2. At any moment, the _moviegoer_ __reneges if__ the movie becomes sold out (the "sold out" event is received).
3. In particular, __leave__ immediately if the movie already became sold out.
4. Reach the ticket counter and stay in the queue. When the turn comes (counter is __seized__),
    1. Try to buy (__seize__ the resource) tickets (randomly chosen between 1 and 6).
        * If there are not enough tickets, the _moviegoer_ is __rejected__ after some discussion.
    2. Provided the _moviegoer_ has tickets, the reneging condition is __aborted__.
    3. Check the tickets available and, if at most one ticket is left...
        * __Set__ instant rejection for future customers (at point 3.).
        * __Send__ the "sold out" event (subscribed at point 2.) for current customers (waiting at point 4.).
5. __Release__ the ticket counter after the duration of the purchase.
6. Enjoy the movie!

This recipe is directly translated into a `simmer` trajectory as follows:

```{r, message=FALSE, warning=FALSE}
moviegoer <- create_trajectory() %>%
  # select a movie
  set_attribute("movie", function() sample(3, 1)) %>%
  select(function(attr) movies[attr["movie"]]) %>%
  # set reneging condition
  renege_if(function(attr) paste0(movies[attr["movie"]], " sold out")) %>%
  # leave immediately if the movie was already sold out
  leave(function(attr) get_capacity(env, movies[attr["movie"]]) == 0) %>%
  # wait for my turn
  seize("counter", 1) %>%
  # buy tickets
  seize_selected(function() sample(6, 1), continue = FALSE,
                 reject = create_trajectory() %>%
                   # not enough tickets, leave after some discussion
                   timeout(0.5) %>%
                   release("counter", 1)
  ) %>%
  # abort reneging condition
  renege_abort() %>%
  # check the tickets available
  branch(function(attr) get_server_count(env, movies[attr["movie"]]) > (TICKETS - 2),
         continue = TRUE,
         # trigger the "sold out" event for the movie
         create_trajectory() %>%
           set_capacity_selected(0) %>%
           send(function(attr) paste0(movies[attr["movie"]], " sold out"))
  ) %>%
  timeout(1) %>%
  release("counter", 1) %>%
  # watch the movie
  wait()
```

which actually constitutes a quite interesting subset of `simmer`'s capabilities. The next step is to add the required resources to the environment `env`: the three movies and the ticket counter.

```{r, message=FALSE, warning=FALSE}
# add movies as resources with capacity TICKETS and no queue
lapply(movies, function(i) add_resource(env, i, TICKETS, 0)) %>% invisible

# add ticket counter with capacity 1 and infinite queue
env %>% add_resource("counter", 1, Inf)
```

And finally, we attach an exponential _moviegoer_ generator to the `moviegoer` trajectory and the simulation starts:

```{r, message=FALSE, warning=FALSE}
# add a moviegoer generator and start simulation
env %>%
  add_generator("moviegoer", moviegoer, function() rexp(1, 1 / 0.5), mon=2) %>%
  run(SIM_TIME)
```

`simmer` _automagically_ monitors the system status, and this information can be retrieved with three methods:

```{r, message=FALSE, warning=FALSE}
arrivals <- get_mon_arrivals(env)
resources <- get_mon_resources(env)
attributes <- get_mon_attributes(env)
```

As we promised, the analysis is performed with the help of `dplyr`:

```{r, message=FALSE, warning=FALSE}
# get the three rows with the sold out instants
sold_time <- resources %>%
  filter(resource != "counter" & capacity == 0)

# get the arrivals that left at the sold out instants
# count the number of arrivals per movie
n_reneges <- left_join(
    arrivals %>% 
      filter(finished == FALSE & end_time %in% sold_time$time),
    attributes
  ) %>%
  mutate(resource = movies[value]) %>%
  group_by(resource) %>%
  count()

# merge the info
result <- left_join(sold_time, n_reneges)
# and print
apply(result, 1, function(i) {
  cat("Movie '", i["resource"], "' sold out ", i["time"], 
      " minutes after ticket counter opening.\n",
      "  Number of people leaving queue when film sold out: ", i["n"], "\n", sep="")
}) %>% invisible
```
